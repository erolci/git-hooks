#!/bin/sh
set -e

# TODO Introduce $CONFIG_NAMESPACE.exclude

if [ "$VERBOSITY" -gt 1 ]
then
    shopt=x
else
    shopt=
fi

if command -v eslint >/dev/null && eslint --print-config dummy.js >/dev/null 2>&1
then
    if git diff --quiet -- '*.js' '*.mjs' '*.jsx' '*.ts' '*.tsx'
    then
        # No unstaged modifications -- running eslint on files

        git diff --cached --diff-filter=ACMR --name-only "$AGAINST" -- '*.js' '*.mjs' '*.jsx' '*.ts' '*.tsx' |
            $XARGS sh -$-"${shopt}" -c "eslint --rule='import/no-unused-modules:0' \"\$@\"" --
    else
        # Some staged modifications -- running eslint on staged diffs

        # TODO Run git-diff once?
        count="$(
            git diff --cached --diff-filter=ACMR --name-only "$AGAINST" -- '*.js' '*.mjs' '*.jsx' '*.ts' '*.tsx' \
                | wc -l
        )"
        if [ "$count" -gt 0 ]
        then
            secondary "Running eslint on %d files." "$count"

            # We are disabling import/no-unused-modules, because it increases linting time significantly
            total="$( git diff --cached --diff-filter=ACMR --name-only "$AGAINST" -- '*.js' '*.mjs' '*.jsx' '*.ts' '*.tsx' | wc -l )"
            git diff --cached --diff-filter=ACMR --name-only "$AGAINST" -- '*.js' '*.mjs' '*.jsx' '*.ts' '*.tsx' |
                nl |
                while read -r number file
                do
                    printf "%d/%d: " "$number" "$total" 1>&2
                    git show :"$file" | {
                        set -"$shopt"
                        eslint --rule='import/no-unused-modules:0' --stdin --stdin-filename="$file"
                    }
                done
        fi
    fi
fi
