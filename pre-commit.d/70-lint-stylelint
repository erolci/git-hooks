#!/bin/sh
set -ue

# TODO Introduce $CONFIG_NAMESPACE.exclude

if [ "$VERBOSITY" -gt 1 ]
then
    shopt=x
else
    shopt=
fi

if command -v stylelint >/dev/null && stylelint --print-config dummy.css >/dev/null 2>&1
then
    # TODO Run git-diff once?
    css_total="$(
        git diff --cached --diff-filter=ACMR --name-only "$AGAINST" '*.css' \
            | wc -l
    )"
    scss_total="$(
        git diff --cached --diff-filter=ACMR --name-only "$AGAINST" '*.scss' \
            | wc -l
    )"
    total=$(( css_total + scss_total ))

    if [ "$total" -gt 0 ]
    then
        secondary "Running stylelint on %d files." "$total"

        # TODO Run single instance for files without local changes
        git diff --cached --diff-filter=ACMR --name-only "$AGAINST" '*.css' |
            nl |
            while read -r number file
            do
                printf "%d/%d: " "$number" "$total" 1>&2
                git show :"$file" | {
                    set -"$shopt"
                    stylelint --stdin-filename="$file"
                }
            done
        git diff --cached --diff-filter=ACMR --name-only "$AGAINST" '*.scss' |
            nl -v$(( css_total + 1 )) |
            while read -r number file
            do
                printf "%d/%d: " "$number" "$total" 1>&2
                git show :"$file" | {
                    set -"$shopt"
                    stylelint --stdin-filename="$file" --syntax=scss
                }
            done
    fi
fi
