#!/bin/sh
# shellcheck disable=SC1111
set -ue

# Redirect output to stderr.
exec 1>&2

GLOBAL_CONFIG_NAMESPACE="hooks"

NULL_REF=0000000000000000000000000000000000000000

random_line ()
{
    if sort --help | grep -q -- --random-sort
    then
        sort --random-sort | head -n1
    else
        # As a fallback use first line
        head -n1
    fi
}

safe_tput ()
{
    tput "$@" 2>/dev/null || :
}

if [ -t 1 ] && [ "$( safe_tput colors )" -gt 8 ]
then
    TPUT_PRIMARY="$( safe_tput sgr0 )"
    TPUT_SECONDARY="$( safe_tput dim )"
    TPUT_ERROR="$( safe_tput setaf 1 )"
    TPUT_WARNING="$( safe_tput setaf 3 )"
else
    TPUT_PRIMARY=""
    TPUT_SECONDARY=""
    TPUT_ERROR=""
    TPUT_WARNING=""
fi

# TODO Set VERBOSITY from --verbose | -v | -vv | -vvv etc.
# TODO Add a hook that checks if --fixup=… matches anything

VERBOSITY="$( git config --get "hooks.verbosity" || echo 0)"
if [ "$VERBOSITY" -gt 2 ]
then
    set -x
fi
export VERBOSITY

PACKAGE_DIR="$( dirname "$( readlink "$0" )" )/.."
export PACKAGE_DIR

BASE_BRANCH="$( git config --get-regexp '^branch\..*\.remote' | head -n1 | cut -d. -f2 )"
export BASE_BRANCH

if git rev-parse --verify HEAD >/dev/null 2>&1
then
    AGAINST=HEAD
else
    # Initial commit: diff against an empty tree object
    AGAINST="$( git hash-object -t tree /dev/null )"
fi
export AGAINST

XARGS_MAX_ARGS=512
if command xargs --help 2>&1 | grep -q -- --no-run-if-empty
then
    # shellcheck disable=SC2139
    alias xargs="command xargs -n $XARGS_MAX_ARGS --no-run-if-empty"
else
    # On MacOS xargs does not have that option (which is a GNU
    # extension), but acts that way by default
    # shellcheck disable=SC2139
    alias xargs="command xargs -n $XARGS_MAX_ARGS"
fi

# Commonly used to disable interactive mode
CI=true
export CI

SHELL="${SHELL:-sh}"
export SHELL

TMPDIR="${TMPDIR:-/tmp}"
export TMPDIR

# Figure out how git was called
parent_cmd="$( ps -p "$PPID" -o command= )"
# Can potencially lead to to some problems
# (e.g. `./tools/git stuff/git commit`), but is good enough, especially
# since we don’t ever run it, just use it to print example commands.
git_cmd_regex="^(\/[a-zA-Z0-9_/-]+\/)?git[[:space:]]+"
if printf "%s" "$parent_cmd" | grep -qE "$git_cmd_regex"
then
    PARENT_ARGV0="$( printf "%s" "$parent_cmd" | sed -E -e "s/($git_cmd_regex).*/\\1/" )"
    PARENT_ARGV="$( printf "%s" "$parent_cmd" | sed -E "s/$git_cmd_regex//" )"
else
    PARENT_ARGV0=
    PARENT_ARGV=
fi
unset parent_cmd


success_messages="All hooks seem happy.
You are all good.
Nice job.
Keep it up.
Everything is good with the world."


cprintf ()
{
    colour="$1"
    prefix="$2"
    fmt="$3"
    shift 3
    # shellcheck disable=SC2059
    printf "${colour}${prefix}${fmt}${TPUT_PRIMARY}\n" "$@"
}

error ()
{
    cprintf "$TPUT_ERROR" "ERROR: " "$@" 1>&2
}

warning ()
{
    cprintf "$TPUT_WARNING" "WARNING: " "$@"
}

secondary ()
{
    cprintf "$TPUT_SECONDARY" "" "$@"
}

is_enabled ()
{
    config_name="$1"
    test "$( git config --get "$config_name" || echo true )" != "false"
}

run_hooks ()
{
    if ! is_enabled "$GLOBAL_CONFIG_NAMESPACE.enabled"
    then
        return
    fi

    hook_type="$( basename "$0" .sh )"
    dir="$PACKAGE_DIR/$hook_type.d"
    pattern="^$( git config --get "$GLOBAL_CONFIG_NAMESPACE.pattern" || echo '.*')$"
    # TODO Support global hooks in ~/.config/githooks (overwritable in git config)
    # TODO Support local hooks in ./.githooks (overwritable in git config)
    find "$dir" -maxdepth 1 -type f | sort |
        while read -r hook
        do
            if [ -x "$hook" ]
            then
                name="$( basename "$hook" .sh  | sed 's/^[0-9_ -]*//' )"
                CONFIG_NAMESPACE="$GLOBAL_CONFIG_NAMESPACE.$name"
                enabled_shorthand_config_name="$CONFIG_NAMESPACE"
                if
                  echo "$name" | grep -q "$pattern" &&
                  is_enabled "$CONFIG_NAMESPACE.enabled" &&
                  is_enabled "$enabled_shorthand_config_name"
                then
                    if [ "$VERBOSITY" -gt 0 ]
                    then
                        secondary "$name"
                    fi

                    export GLOBAL_CONFIG_NAMESPACE CONFIG_NAMESPACE
                    export NULL_REF
                    # shellcheck disable=SC1090
                    if ! ( . "$hook" )
                    then
                        error "%s “%s” hook failed" "$hook_type" "$name"
                        if [ -z "$PARENT_ARGV0" ]
                        then
                            secondary "To temporary disable add this directly after \`git\`:\n    -c %s=false " "$enabled_shorthand_config_name"
                        else
                            secondary "To temporary disable run:\n    %s-c %s=false %s" "$PARENT_ARGV0" "$enabled_shorthand_config_name" "$PARENT_ARGV"
                        fi
                        false
                    fi
                fi
            fi
        done

    if [ "$VERBOSITY" -gt -1 ]
    then
        printf '✅ '
        echo "$success_messages" | random_line
    fi
}
